# 模块说明：Helm 模板 - CronJob。

apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "automation-hub.fullname" . }}-daily-report
  namespace: {{ .Release.Namespace | default "automation-hub" }}
spec:
  schedule: "0 9 * * *"  # 每天9点执行
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 600
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: automation-hub
            component: cronjob
        spec:
          serviceAccountName: {{ include "automation-hub.fullname" . }}-worker-sa
          restartPolicy: OnFailure
          containers:
          - name: cronjob
            image: "{{ .Values.worker.image.repository }}:{{ .Values.worker.image.tag | default .Chart.AppVersion }}"
            command: ["python"]
            args:
              - "/app/scripts/daily_report.py"
              - "--output_path"
              - "/workspace/reports/daily_{{ .Values.date }}.md"
            env:
            - name: WORKSPACE_PATH
              value: {{ .Values.worker.env.WORKSPACE_PATH }}
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
          tolerations:
            {{- toYaml .Values.worker.tolerations | nindent 12 }}