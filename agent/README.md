# Agent è§„åˆ’ä¸è°ƒåº¦å±‚

## ğŸ“‹ æ¦‚è¿°

Agent å±‚æ˜¯ Automation Hub çš„æ ¸å¿ƒæ™ºèƒ½ç»„ä»¶ï¼Œè´Ÿè´£å°†ç”¨æˆ·çš„è‡ªç„¶è¯­è¨€è¯·æ±‚è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„å·¥å…·è°ƒç”¨åºåˆ—ã€‚

## ğŸ—ï¸ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Agent å±‚æ¶æ„                             â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Planner    â”‚â”€â”€â”€â–¶â”‚   Executor   â”‚â”€â”€â”€â–¶â”‚   Context    â”‚  â”‚
â”‚  â”‚ (æ„å›¾ç†è§£)    â”‚    â”‚  (å·¥å…·ç¼–æ’)   â”‚    â”‚  (ä¸Šä¸‹æ–‡ç®¡ç†) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                    â”‚                    â”‚          â”‚
â”‚         â–¼                    â–¼                    â–¼          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Shared Memory (å¯¹è¯çŠ¶æ€)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ æ¨¡å—è¯´æ˜

### 1. `models.py` - æ•°æ®æ¨¡å‹

å®šä¹‰æ ¸å¿ƒæ•°æ®ç»“æ„ï¼š
- `TaskType`: ä»»åŠ¡ç±»å‹æšä¸¾
- `StepStatus`: æ­¥éª¤çŠ¶æ€æšä¸¾
- `PlanStep`: æ‰§è¡Œæ­¥éª¤
- `ExecutionPlan`: å®Œæ•´è®¡åˆ’
- `StepResult`: æ­¥éª¤ç»“æœ
- `ExecutionResult`: æ‰§è¡Œç»“æœ

### 2. `context.py` - ä¸Šä¸‹æ–‡ç®¡ç†

ç®¡ç†å¯¹è¯çŠ¶æ€ï¼š
- å¯¹è¯å†å²ï¼ˆæœ€è¿‘20æ¡ï¼‰
- å·¥ä½œç›®å½•
- æœ€è¿‘è®¿é—®çš„æ–‡ä»¶
- é¡¹ç›®ç±»å‹
- ç”¨æˆ·åå¥½
- ä¸´æ—¶å˜é‡

### 3. `planner.py` - è§„åˆ’å™¨

å°†è‡ªç„¶è¯­è¨€è½¬æ¢ä¸ºæ‰§è¡Œè®¡åˆ’ï¼š
- è°ƒç”¨ LLM ç†è§£æ„å›¾
- æŸ¥è¯¢å¯ç”¨å·¥å…·
- ç”Ÿæˆæ­¥éª¤åºåˆ—
- éªŒè¯è®¡åˆ’åˆæ³•æ€§

### 4. `executor.py` - æ‰§è¡Œå™¨

æ‰§è¡Œè§„åˆ’å¥½çš„æ­¥éª¤ï¼š
- æŒ‰ä¾èµ–å…³ç³»æ‰§è¡Œ
- å¤„ç†å®¡æ‰¹æµç¨‹
- è‡ªåŠ¨é‡è¯•
- å¤±è´¥å›æ»š

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```python
from automation_hub.agent import AgentPlanner, AgentExecutor, ConversationContext

# åˆå§‹åŒ–
planner = AgentPlanner(llm_client, db_path="data/automation_hub.sqlite3")
executor = AgentExecutor(api_client, approval_handler)

# åˆ›å»ºä¸Šä¸‹æ–‡
context = ConversationContext(user_id="user123", session_id="session456")

# ç”Ÿæˆè®¡åˆ’
plan = await planner.plan("æœç´¢æ‰€æœ‰ TODO æ³¨é‡Š", context)

# æ‰§è¡Œè®¡åˆ’
result = await executor.execute_plan(plan, user_id="user123")

# æŸ¥çœ‹ç»“æœ
print(result.summary)
```

### API ä½¿ç”¨

```bash
# è¯¢é—® Agent
curl -X POST http://localhost:8000/agent/ask \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æœç´¢æ‰€æœ‰ TODO æ³¨é‡Š",
    "session_id": "optional-session-id"
  }'

# ä»…ç”Ÿæˆè®¡åˆ’ï¼ˆä¸æ‰§è¡Œï¼‰
curl -X POST http://localhost:8000/agent/plan \
  -H "Content-Type: application/json" \
  -d '{
    "query": "æ ¼å¼åŒ–æ‰€æœ‰ Python æ–‡ä»¶"
  }'
```

## ğŸ”§ é…ç½®

### LLM é…ç½®

æ¨èä½¿ç”¨å†…ç½®çš„ OpenAI å…¼å®¹å®¢æˆ·ç«¯ï¼ˆæ— éœ€é¢å¤–ä¾èµ–ï¼‰ï¼š

```python
from automation_hub.agent import OpenAICompatibleClient, AgentPlanner

llm_client = OpenAICompatibleClient()  # è¯»å–ç¯å¢ƒå˜é‡
planner = AgentPlanner(llm_client, db_path="data/automation_hub.sqlite3")
```

ç¯å¢ƒå˜é‡ï¼š
- `OPENAI_API_KEY`ï¼ˆå¿…å¡«ï¼‰
- `OPENAI_BASE_URL`ï¼ˆå¯é€‰ï¼Œé»˜è®¤ https://api.openai.com/v1ï¼‰
- `OPENAI_MODEL`ï¼ˆå¯é€‰ï¼Œé»˜è®¤ gpt-4o-miniï¼‰

### æ•°æ®åº“é…ç½®

ç¡®ä¿æ•°æ®åº“è·¯å¾„æ­£ç¡®ï¼š

```python
planner = AgentPlanner(
    llm_client=your_llm_client,
    db_path="data/automation_hub.sqlite3"  # æˆ–å…¶ä»–è·¯å¾„
)
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•ï¼š

```bash
# æµ‹è¯•ä¸Šä¸‹æ–‡ç®¡ç†
pytest automation-hub/agent/tests/test_context.py -v

# æµ‹è¯•æ•°æ®æ¨¡å‹
pytest automation-hub/agent/tests/test_models.py -v

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest automation-hub/agent/tests/ -v
```

## ğŸ“ ç¤ºä¾‹åœºæ™¯

### 1. ç®€å•æœç´¢

```python
# ç”¨æˆ·: "å¸®æˆ‘æ‰¾å‡ºæ‰€æœ‰æœªä½¿ç”¨çš„å¯¼å…¥"
plan = await planner.plan("å¸®æˆ‘æ‰¾å‡ºæ‰€æœ‰æœªä½¿ç”¨çš„å¯¼å…¥", context)
# ç”Ÿæˆçš„è®¡åˆ’:
# [
#   {
#     "step_id": "step_1",
#     "tool_id": "code_search",
#     "args": {"pattern": "^import\\s+.*$", "unused_only": true}
#   }
# ]
```

### 2. å¤šæ­¥éª¤ä»»åŠ¡

```python
# ç”¨æˆ·: "æ ¼å¼åŒ–æ‰€æœ‰ Python æ–‡ä»¶å¹¶è¿è¡Œæµ‹è¯•"
plan = await planner.plan("æ ¼å¼åŒ–æ‰€æœ‰ Python æ–‡ä»¶å¹¶è¿è¡Œæµ‹è¯•", context)
# ç”Ÿæˆçš„è®¡åˆ’:
# [
#   {
#     "step_id": "step_1",
#     "tool_id": "format_code",
#     "args": {"files": "**/*.py"}
#   },
#   {
#     "step_id": "step_2",
#     "tool_id": "run_tests",
#     "depends_on": ["step_1"]
#   }
# ]
```

### 3. ä¸Šä¸‹æ–‡ç†è§£

```python
# ç¬¬ä¸€æ¬¡å¯¹è¯
await planner.plan("åˆ†æè¿™ä¸ªé¡¹ç›®çš„ç»“æ„", context)
# ä¸Šä¸‹æ–‡æ›´æ–°: project_type="python", working_directory="/path/to/project"

# ç¬¬äºŒæ¬¡å¯¹è¯ï¼ˆç†è§£"è¿™ä¸ªé¡¹ç›®"æŒ‡ä»£ï¼‰
await planner.plan("æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ", context)
# Agent ä¼šåŸºäºä¹‹å‰çš„ä¸Šä¸‹æ–‡ç†è§£"è¿™ä¸ªé¡¹ç›®"
```

## ğŸ”œ å¾…å®ç°åŠŸèƒ½

- [ ] LLM å®é™…é›†æˆï¼ˆOpenAI/Claudeï¼‰
- [ ] è®¡åˆ’æŒä¹…åŒ–ï¼ˆå­˜å‚¨åˆ°æ•°æ®åº“ï¼‰
- [ ] å¹¶è¡Œæ‰§è¡Œæ— ä¾èµ–æ­¥éª¤
- [ ] æ›´å®Œå–„çš„é”™è¯¯å¤„ç†
- [ ] è®¡åˆ’ç¼“å­˜å’Œä¼˜åŒ–
- [ ] å¤šè½®å¯¹è¯æ”¹è¿›
- [ ] Few-shot ç¤ºä¾‹ä¼˜åŒ–

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ARCHITECTURE_DESIGN.md](../../ARCHITECTURE_DESIGN.md) - æ•´ä½“æ¶æ„è®¾è®¡
- [api.md](../../docs/api.md) - API æ–‡æ¡£
- [tool-spec.md](../../docs/tool-spec.md) - å·¥å…·è§„èŒƒ

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç ã€æŠ¥å‘Šé—®é¢˜æˆ–æå‡ºæ”¹è¿›å»ºè®®ï¼
