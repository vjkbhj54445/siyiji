# Sprint 1 部署检查清单

## 数据库迁移

- [ ] 执行迁移脚本：`python automation-hub/api/db/migrate.py`
- [ ] 验证所有表已创建：
  - [ ] users
  - [ ] devices
  - [ ] api_tokens
  - [ ] tools
  - [ ] tool_versions
  - [ ] approval_requests
  - [ ] audit_events
  - [ ] proposals（可选）
  - [ ] repos（可选）

## 系统初始化

- [ ] 启动 API 服务
- [ ] 调用 `/auth/bootstrap` 创建管理员
- [ ] 保存管理员 token
- [ ] 测试 `/auth/me` 验证 token 有效

## 基础功能测试

### 认证模块

- [ ] 创建新设备
- [ ] 创建新 token（带不同 scopes）
- [ ] 测试权限检查（访问需要特定 scope 的接口）
- [ ] 吊销 token
- [ ] 验证吊销后无法使用

### 工具注册

- [ ] 注册测试工具（read 级别）
- [ ] 注册高风险工具（exec_high/write 级别）
- [ ] 列出所有工具
- [ ] 查看工具详情
- [ ] 禁用/启用工具
- [ ] 创建工具版本

### 执行流程

#### 低风险工具（无需审批）

- [ ] 执行 read 级别工具
- [ ] 验证直接入队
- [ ] 查看运行状态
- [ ] 检查 stdout/stderr 日志
- [ ] 验证审计日志记录

#### 高风险工具（需审批）

- [ ] 执行 exec_high 工具
- [ ] 验证返回 pending_approval 状态
- [ ] 查看待审批列表
- [ ] 批准审批请求
- [ ] 验证 Worker 执行
- [ ] 查看审计日志

### 审批系统

- [ ] 创建审批请求
- [ ] 列出待审批
- [ ] 批准请求
- [ ] 拒绝请求
- [ ] 验证状态转换正确
- [ ] 检查审计记录

### 审计系统

- [ ] 查询所有审计事件
- [ ] 按事件类型筛选
- [ ] 按资源类型筛选
- [ ] 按时间范围筛选
- [ ] 验证关键操作都有记录

## Worker 测试

- [ ] 启动 Worker 服务
- [ ] 执行简单工具
- [ ] 执行需要审批的工具
- [ ] 验证 Host Executor
- [ ] 验证 Docker Executor（如已实现）
- [ ] 测试超时处理
- [ ] 测试失败处理

## 策略引擎测试

- [ ] 测试 scope 检查
- [ ] 测试工具禁用检查
- [ ] 测试风险级别评估
- [ ] 测试 JSON Schema 验证
- [ ] 测试路径权限检查

## 安全测试

- [ ] 无 token 访问被拒绝
- [ ] 无效 token 被拒绝
- [ ] 已吊销 token 被拒绝
- [ ] 权限不足被拒绝
- [ ] 禁用工具无法执行
- [ ] 未批准的高风险操作被阻止

## 性能测试

- [ ] 并发执行多个工具
- [ ] 长时间运行的工具
- [ ] 大量审计日志查询
- [ ] 工具列表性能

## 文档验证

- [ ] README 准确描述功能
- [ ] RBAC 文档完整
- [ ] 工具规范清晰
- [ ] 审批流程文档准确
- [ ] API 示例可用

## 部署验证

### Docker

- [ ] 构建 Docker 镜像
- [ ] 运行容器
- [ ] 数据持久化
- [ ] 环境变量配置

### Kubernetes（可选）

- [ ] 应用 K8s 配置
- [ ] 验证服务可访问
- [ ] PVC 挂载正确
- [ ] ConfigMap/Secret 正确

## 监控和日志

- [ ] 应用日志正常输出
- [ ] Worker 日志可查看
- [ ] 错误日志包含足够信息
- [ ] 审计日志完整

## 回滚准备

- [ ] 数据库备份
- [ ] 配置文件备份
- [ ] 回滚步骤文档化

## 已知问题和限制

记录当前版本的已知问题：

- Docker Executor 当前简化实现，未真正使用 Docker
- Token 过期检查未实现
- Proposals 系统未实现
- Repos 索引系统未实现
- 通知机制未实现

## 下一步计划

### Sprint 2

- [ ] 迁移现有脚本到工具注册
- [ ] 完善 Docker Executor 实现
- [ ] 实现 token 过期检查
- [ ] 添加工具依赖管理

### Sprint 3

- [ ] 实现 Repos 索引
- [ ] 集成代码搜索（ripgrep）
- [ ] 语法树解析

### Sprint 4

- [ ] 实现 Proposals 系统
- [ ] Patch 应用和回滚
- [ ] 验证命令执行
